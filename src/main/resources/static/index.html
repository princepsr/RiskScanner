<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Risk Scanner</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background: #0b1220; color: #e8edf6; }
    .container { max-width: 1100px; margin: 0 auto; padding: 28px 18px 48px; }
    h1 { margin: 0 0 18px; font-size: 26px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { background: #0f1a33; border: 1px solid #243458; border-radius: 12px; padding: 14px; }
    .row { display: grid; grid-template-columns: 140px 1fr; gap: 10px; align-items: center; margin: 10px 0; }
    label { color: #b8c6e6; font-size: 13px; }
    input, select { width: 100%; padding: 10px 10px; border-radius: 10px; border: 1px solid #2b3b64; background: #0b1220; color: #e8edf6; }
    button { background: #4f7cff; border: 0; color: white; padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    button.secondary { background: #1e2d52; border: 1px solid #2b3b64; }
    button.danger { background: #ff4f6d; }
    .buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .status { margin-top: 10px; font-size: 13px; color: #b8c6e6; white-space: pre-wrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { border-bottom: 1px solid #243458; padding: 10px 8px; text-align: left; font-size: 13px; vertical-align: top; }
    th { color: #b8c6e6; font-weight: 700; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; font-weight: 700; font-size: 12px; }
    .pill.HIGH { background: rgba(255,79,109,0.2); color: #ff8aa0; border: 1px solid rgba(255,79,109,0.4); }
    .pill.MEDIUM { background: rgba(255,190,75,0.18); color: #ffd79a; border: 1px solid rgba(255,190,75,0.35); }
    .pill.LOW { background: rgba(80,220,150,0.16); color: #98f0c6; border: 1px solid rgba(80,220,150,0.3); }
    .pill.UNKNOWN { background: rgba(160,170,190,0.18); color: #d0d6e2; border: 1px solid rgba(160,170,190,0.35); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Risk Scanner</h1>

    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 10px; font-size:16px; color:#e8edf6;">AI Connection Setup</h2>
        <div class="row">
          <label>Provider</label>
          <select id="provider">
            <option value="openai">OpenAI</option>
          </select>
        </div>
        <div class="row">
          <label>Model</label>
          <input id="model" placeholder="gpt-4o" value="gpt-4o" />
        </div>
        <div class="row">
          <label>API Key</label>
          <input id="apiKey" placeholder="sk-..." type="password" />
        </div>
        <div class="buttons">
          <button id="saveSettings">Save Settings</button>
          <button class="secondary" id="testConnection">Test Connection</button>
          <button class="secondary" id="loadSettings">Load Settings</button>
        </div>
        <div class="status" id="aiStatus"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px; font-size:16px; color:#e8edf6;">Project</h2>
        <div class="row">
          <label>Project Path</label>
          <input id="projectPath" placeholder="C:\\path\\to\\project (folder)" />
        </div>
        <div class="row">
          <label>Force Refresh</label>
          <select id="forceRefresh">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div class="buttons">
          <button id="scan">Scan</button>
          <button id="analyze">Analyze</button>
          <button class="secondary" id="loadCached">Load Cached</button>
          <button class="secondary" id="exportJson">Export JSON</button>
          <button class="secondary" id="exportPdf">Export PDF</button>
        </div>
        <div class="status" id="projectStatus"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2 style="margin:0 0 10px; font-size:16px; color:#e8edf6;">Results</h2>
      <div id="resultsMeta" class="status"></div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Dependency</th>
              <th>Risk</th>
              <th>Score</th>
              <th>Explanation</th>
              <th>Recommendations</th>
              <th>Cache</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setStatus(el, text) {
      el.textContent = text || "";
    }

    function renderResults(results, meta) {
      const body = $("resultsBody");
      body.innerHTML = "";
      $("resultsMeta").textContent = meta || "";

      (results || []).forEach(r => {
        const tr = document.createElement('tr');
        const dep = `${r.groupId}:${r.artifactId}:${r.version}`;
        const recs = (r.recommendations || []).map(x => `- ${x}`).join("\n");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(dep)}</td>
          <td><span class="pill ${r.riskLevel || 'UNKNOWN'}">${r.riskLevel || 'UNKNOWN'}</span></td>
          <td>${r.riskScore ?? ""}</td>
          <td>${escapeHtml(r.explanation || "")}</td>
          <td class="mono" style="white-space:pre-wrap;">${escapeHtml(recs)}</td>
          <td>${r.fromCache ? "yes" : "no"}</td>
        `;
        body.appendChild(tr);
      });
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    async function jsonFetch(url, options) {
      const res = await fetch(url, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`${res.status} ${res.statusText}: ${text}`);
      }
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) return await res.json();
      return await res.text();
    }

    async function downloadPostJson(url, body, filename) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`${res.status} ${res.statusText}: ${text}`);
      }
      const blob = await res.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename || 'risk-report.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    async function downloadPost(url, body, filename) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`${res.status} ${res.statusText}: ${text}`);
      }
      const blob = await res.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename || 'download';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    $("loadSettings").addEventListener('click', async () => {
      try {
        setStatus($("aiStatus"), "Loading settings...");
        const s = await jsonFetch('/api/ai/settings', { method: 'GET' });
        $("provider").value = s.provider || 'openai';
        $("model").value = s.model || 'gpt-4o';
        $("apiKey").value = '';
        setStatus($("aiStatus"), `Loaded. configured=${s.configured} updatedAt=${s.updatedAt || ''}`);
      } catch (e) {
        setStatus($("aiStatus"), e.message);
      }
    });

    $("saveSettings").addEventListener('click', async () => {
      try {
        setStatus($("aiStatus"), "Saving...");
        const payload = {
          provider: $("provider").value,
          model: $("model").value,
          apiKey: $("apiKey").value,
        };
        const s = await jsonFetch('/api/ai/settings', { method: 'PUT', body: JSON.stringify(payload) });
        $("apiKey").value = '';
        setStatus($("aiStatus"), `Saved. provider=${s.provider} model=${s.model} updatedAt=${s.updatedAt || ''}`);
      } catch (e) {
        setStatus($("aiStatus"), e.message);
      }
    });

    $("testConnection").addEventListener('click', async () => {
      try {
        setStatus($("aiStatus"), "Testing...");
        const r = await jsonFetch('/api/ai/test-connection', { method: 'POST' });
        setStatus($("aiStatus"), `Test OK: ${r}`);
      } catch (e) {
        setStatus($("aiStatus"), e.message);
      }
    });

    $("scan").addEventListener('click', async () => {
      try {
        setStatus($("projectStatus"), "Scanning...");
        const p = encodeURIComponent($("projectPath").value);
        const deps = await jsonFetch(`/api/project/scan?projectPath=${p}`, { method: 'GET' });
        renderResults((deps || []).map(d => ({
          groupId: d.groupId,
          artifactId: d.artifactId,
          version: d.version,
          riskLevel: 'UNKNOWN',
          explanation: '',
          recommendations: [],
          fromCache: false,
          buildTool: d.buildTool,
        })), `Scanned ${deps.length} dependencies.`);
        setStatus($("projectStatus"), `Scan complete: ${deps.length} dependencies`);
      } catch (e) {
        setStatus($("projectStatus"), e.message);
      }
    });

    $("analyze").addEventListener('click', async () => {
      try {
        setStatus($("projectStatus"), "Analyzing...");
        const payload = {
          projectPath: $("projectPath").value,
          forceRefresh: $("forceRefresh").value === 'true',
        };
        const r = await jsonFetch('/api/project/analyze', { method: 'POST', body: JSON.stringify(payload) });
        renderResults(r.results || [], `Analyzed at ${r.analyzedAt || ''}`);
        setStatus($("projectStatus"), `Analyze complete: ${(r.results || []).length} results`);
      } catch (e) {
        setStatus($("projectStatus"), e.message);
      }
    });

    $("loadCached").addEventListener('click', async () => {
      try {
        setStatus($("projectStatus"), "Loading cached results...");
        const r = await jsonFetch('/api/dashboard/cached-results', { method: 'GET' });
        renderResults(r || [], `Cached results: ${(r || []).length}`);
        setStatus($("projectStatus"), `Loaded ${(r || []).length} cached results`);
      } catch (e) {
        setStatus($("projectStatus"), e.message);
      }
    });

    $("exportJson").addEventListener('click', async () => {
      try {
        setStatus($("projectStatus"), "Exporting...");
        const payload = {
          projectPath: $("projectPath").value,
          forceRefresh: false,
        };
        await downloadPostJson('/api/export/json', payload, 'risk-report.json');
        setStatus($("projectStatus"), "Exported JSON");
      } catch (e) {
        setStatus($("projectStatus"), e.message);
      }
    });

    $("exportPdf").addEventListener('click', async () => {
      try {
        setStatus($("projectStatus"), "Exporting...");
        const payload = {
          projectPath: $("projectPath").value,
          forceRefresh: false,
        };
        await downloadPost('/api/export/pdf', payload, 'risk-report.pdf');
        setStatus($("projectStatus"), "Exported PDF");
      } catch (e) {
        setStatus($("projectStatus"), e.message);
      }
    });

    (async () => {
      try {
        const s = await jsonFetch('/api/ai/settings', { method: 'GET' });
        $("provider").value = s.provider || 'openai';
        $("model").value = s.model || 'gpt-4o';
      } catch (_) {
      }
    })();
  </script>
</body>
</html>
